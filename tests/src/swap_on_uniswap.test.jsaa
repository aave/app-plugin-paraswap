import "core-js/stable";
import "regenerator-runtime/runtime";
import Eth from "@ledgerhq/hw-app-eth";
import { byContractAddress } from "@ledgerhq/hw-app-eth/erc20";
import Zemu from "@zondax/zemu";
import { TransportStatusError } from "@ledgerhq/errors";

const sim_options = {
  model: "nanos",
  logging: true,
  start_delay: 2000,
  X11: true,
  custom: '',
};
const Resolve = require("path").resolve;
const APP_PATH = Resolve("elfs/ethereum.elf");

const PARASWAP_LIB = { Paraswap: Resolve("elfs/paraswap.elf") };

test("Test Swap on Uniswap", async () => {
  jest.setTimeout(100000);
  const sim = new Zemu(APP_PATH, PARASWAP_LIB);
  try {
    await sim.start(sim_options);

    let transport = await sim.getTransport();
    const eth = new Eth(transport);

    // Original TX: https://etherscan.io/tx/0x6b6aeef79fc7e295109fd6dd6f614753e30996a8ac1d5c15269c440c4c768df5
    // Send 145 API3
    // Receive 0.283184134935736098
    // Fees 0.008769654
    await expect(
      eth.signTransaction(
        "44'/60'/0'/0/0",
        "f9014a30850bdfd63e0083029fb2941bd435f3c054b6e901b7b108a0ab7617c808677b80b8e458b9d179000000000000000000000000000000000000000000000007dc477bc1cfa4000000000000000000000000000000000000000000000000000003ee127868deef220000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b38210ea11411557c13457d4da7dc6ea731b88a000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee26a022380972064ddd3aef0178dec7f1a2542df6ad8c5d95ccd6e29d6f0e0a3f938ca04343dcc66bf041170803672fd96d6d7b2030c0bb3ecd3069e247475f30edc9ec"
      )
    ).resolves.toEqual({
      r: "e8c2b5b956b34386e68c5cc5bfc76aac158706430fcf1c71c9f6eb7d9dd690c8",
      s: "064005410a778b047fdd4afcb1e712217c297e5b0a2190f88b9e56ac745fae69",
      v: "26",
    });
  } finally {
    await sim.close();
  }
});

/*
e00a00006704415049330b38210ea11411557c13457d4da7dc6ea731b88a000000120000000130440220355d7c21511acf22cdaf4ca8ac03c8853f58bd0f8bb8bf5d815d1847b0a007b202207f8787ae8100285e562338594269836b0216327cfb3302c08ce40182b44f16bb
e0120000680850617261737761701bd435f3c054b6e901b7b108a0ab7617c808677b58b9d1793045022100fcf9f8608a5907d4a350ee04cb1f4871d1fcc55928b2884179c299f269b036cd022071846ae2faef7383de89adfc91440243f5a30b7249c899a49fa4333e882e20bf
E004000096058000002C8000003C800000000000000000000000F9014A30850BDFD63E0083029FB2941BD435F3C054B6E901B7B108A0AB7617C808677B80B8E458B9D179000000000000000000000000000000000000000000000007DC477BC1CFA4000000000000000000000000000000000000000000000000000003EE127868DEEF220000000000000000000000000000000000000000000000
E004800096000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b38210ea11411557c13457d4da7dc6ea731b88a000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee26a022380972064ddd3aef0178
E004800036dec7f1a2542df6ad8c5d95ccd6e29d6f0e0a3f938ca04343dcc66bf041170803672fd96d6d7b2030c0bb3ecd3069e247475f30edc9ec
*/