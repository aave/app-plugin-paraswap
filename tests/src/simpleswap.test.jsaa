import "core-js/stable";
import "regenerator-runtime/runtime";
import Eth from "@ledgerhq/hw-app-eth";
import { byContractAddress } from "@ledgerhq/hw-app-eth/erc20";
import Zemu from "@zondax/zemu";
import { TransportStatusError } from "@ledgerhq/errors";

const sim_options = {
  model: "nanos",
  logging: true,
  X11: true,
  custom: '',
};
const Resolve = require("path").resolve;
const APP_PATH = Resolve("elfs/ethereum.elf");

const PARASWAP_LIB = { Paraswap: Resolve("elfs/paraswap.elf") };

test("Test SimpleSwap", async () => {
  jest.setTimeout(100000);
  const sim = new Zemu(APP_PATH, PARASWAP_LIB);
  try {
    await sim.start(sim_options);

    let transport = await sim.getTransport();
    const eth = new Eth(transport);

    // Original TX: https://etherscan.io/tx/0x6b2c4d8e3292d59712b3092fda9b92b2ea9f6714d43c31e80a2d720d541748b2
    // Send 2796.674211928951577378 CRV 
    // Receive ETH 2.6546870621893189
    // Max Fees: 0.0125817
    await expect(
      eth.signTransaction(
        "44'/60'/0'/0/0",
        "f905ad8203fc850bdfd63e008303c3ac941bd435f3c054b6e901b7b108a0ab7617c808677b80b90544cfc0afeb000000000000000000000000d533a949740bb3306d119cc777fa900ba034cd52000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000979ba6ba5598ad5b2200000000000000000000000000000000000000000000000024d757d1639ea2f40000000000000000000000000000000000000000000000002506bc99d69cdc60000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000def1c0ded9bec7f1a1670819833240f027b25eff0000000000000000000000001bd435f3c054b6e901b7b108a0ab7617c808677b0000000000000000000000000000000000000000000000000000000000000208aa77476c000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000d533a949740bb3306d119cc777fa900ba034cd520000000000000000000000000000000000000000000000002570c704bf68300000000000000000000000000000000000000000000000009924c024822e84000000000000000000000000000056178a0d5f301baf6cf3e1cd53d9863437345bf90000000000000000000000001bd435f3c054b6e901b7b108a0ab7617c808677b0000000000000000000000003be0d7d9365f085bb08c395d022c5834aae69a3a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006095036f000000000000000000000000000000000000000000000000167cbd81571c7dbc0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000001cf7758b0cce1249cd921b7341015e6a25dc7412e8e19e81482b1b3aa6e15160bd1222f2c76342d45135e03c8517cfa517def897267c877627ffd20fc811f125350000000000000000000000000000000000000000000000979ba6ba5598ad5b22e1829cfe000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e40000000000000000000000000000000000000000000000000000000000000208000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b70617261737761702e696f00000000000000000000000000000000000000000026a062352bfe69f66babab0a74a58f879ecba1f51e6a260b621019e4095f179225ffa01083cbc3b150c05f21152884ef4ff1d46365f06fd0f0acce65a574eed25791ba"
        // second "f904158235e3853b5f2f360083031849941bd435f3c054b6e901b7b108a0ab7617c808677b8829a2241af62c0000b903a4cfc0afeb000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000004946c0e9f43f4dee607b0ef1fa1c00000000000000000000000000000000000000000000000029a2241af62c00000000000000000000000000000000000000000000000000000000000000000b060000000000000000000000000000000000000000000000000000000000000b5e000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000003200000000000000000000000004d246be90c2f36730bb853ad41d0a189061192d300000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000086d3579b043585a97532514016dcf0c2d6c4b6a100000000000000000000000000000000000000000000000000000000000000c499585aac00000000000000000000000000000000000000000000000029a2241af62c0000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000004946c0e9f43f4dee607b0ef1fa1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c4000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000029a2241af62c0000000000000000000000000000000000000000000000000000000000000000000b70617261737761702e696f00000000000000000000000000000000000000000025a08306578e9dbdb3ca694fb6db7579dcfdd3093c096943d6e10b95a2d87aaf2173a02ad98357104c60456a9d08839b2f918236c099002786e2669e140d80568b774e"
      )
    ).resolves.toEqual({
      r: "e8c2b5b956b34386e68c5cc5bfc76aac158706430fcf1c71c9f6eb7d9dd690c8",
      s: "064005410a778b047fdd4afcb1e712217c297e5b0a2190f88b9e56ac745fae69",
      v: "26",
    });
  } finally {
    await sim.close();
  }
});

// Works
/*
e00a00006703435256d533a949740bb3306d119cc777fa900ba034cd5200000012000000013045022100e47621bca5d6aeb32925b7c270f5683edbc9d3ca00ed4d56d596a8e0589079dd022018f998767ed9351cd410b3370a284a8157aa1d887069c214a3f0cc8e8b3ed6bf
e0120000670850617261737761701bd435f3c054b6e901b7b108a0ab7617c808677bcfc0afeb304402201c0cbe69aac517825b3a6eb5e7251e8fd57ff93a43bd3df52c7a841818eda81b022001a10cc326efaee2463fc96e7c29739c308fb8179bd2ac37303662bae4f7705c
E004000096058000002C8000003C800000000000000000000000F905AD8203FC850BDFD63E008303C3AC941BD435F3C054B6E901B7B108A0AB7617C808677B80B90544CFC0AFEB000000000000000000000000D533A949740BB3306D119CC777FA900BA034CD52000000000000000000000000EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE0000000000000000000000000000000000000000
E004800096000000979ba6ba5598ad5b2200000000000000000000000000000000000000000000000024d757d1639ea2f40000000000000000000000000000000000000000000000002506bc99d69cdc60000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001e000000000000000000000
E0048000960000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000004a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000000
E0048000960000000000000000000000000000000000000000000000000000000000000002000000000000000000000000def1c0ded9bec7f1a1670819833240f027b25eff0000000000000000000000001bd435f3c054b6e901b7b108a0ab7617c808677b0000000000000000000000000000000000000000000000000000000000000208aa77476c000000000000000000000000c02aaa39b223
E004800096fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000d533a949740bb3306d119cc777fa900ba034cd520000000000000000000000000000000000000000000000002570c704bf68300000000000000000000000000000000000000000000000009924c024822e84000000000000000000000000000056178a0d5f301baf6cf3e1cd53d9863437345bf90000000000000000
E004800096000000001bd435f3c054b6e901b7b108a0ab7617c808677b0000000000000000000000003be0d7d9365f085bb08c395d022c5834aae69a3a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006095036f000000000000000000000000000000000000000000000000167cbd81571c
E0048000967dbc0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000001cf7758b0cce1249cd921b7341015e6a25dc7412e8e19e81482b1b3aa6e15160bd1222f2c76342d45135e03c8517cfa517def897267c877627ffd20fc811f125350000000000000000000000000000000000000000
E004800096000000979ba6ba5598ad5b22e1829cfe000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
E0048000960000000000000000000000000000000001e4000000000000000000000000000000000000000000000000000000000000020800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
E00480007F0000000000000000000000000000000000000000000000000000000b70617261737761702e696f00000000000000000000000000000000000000000026a062352bfe69f66babab0a74a58f879ecba1f51e6a260b621019e4095f179225ffa01083cbc3b150c05f21152884ef4ff1d46365f06fd0f0acce65a574eed25791ba
*/

// https://etherscan.io/tx/0x81e3770172e2fe0ab6493f9e6e9ecf1085109db37aefe3a62e6078c32504e50a
// Works
// Beneficiary: 0x4d246bE90C2f36730bb853aD41d0a189061192d3
/*
e0120000670850617261737761701bd435f3c054b6e901b7b108a0ab7617c808677bcfc0afeb304402201c0cbe69aac517825b3a6eb5e7251e8fd57ff93a43bd3df52c7a841818eda81b022001a10cc326efaee2463fc96e7c29739c308fb8179bd2ac37303662bae4f7705c
E004000096058000002C8000003C800000000000000000000000F904158235E3853B5F2F360083031849941BD435F3C054B6E901B7B108A0AB7617C808677B8829A2241AF62C0000B903A4CFC0AFEB000000000000000000000000EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE0000000000000000000000000000000000004946C0E9F43F4DEE607B0EF1FA1C000000000000000000000000
E00480009600000000000000000000000029A2241AF62C00000000000000000000000000000000000000000000000000000000000000000B060000000000000000000000000000000000000000000000000000000000000B5E000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001C00000
E0048000960000000000000000000000000000000000000000000000000000000002C000000000000000000000000000000000000000000000000000000000000003200000000000000000000000004D246BE90C2F36730BB853AD41D0A189061192D30000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000
E0048000960000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000086D3579B043585A97532514016DCF0C2D6C4B6A100000000000000000000000000000000000000000000000000000000000000C499585AAC00000000000000000000000000000000000000000000000029A2241AF62C000000000000000000000000
E0048000960000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE0000000000000000000000000000000000004946C0E9F43F4DEE607B0EF1FA1C
E004800096000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C40000000000000000000000000000000000000000000000000000
E00480009600000000000100000000000000000000000000000000000000000000000029A2241AF62C0000000000000000000000000000000000000000000000000000000000000000000B70617261737761702E696F00000000000000000000000000000000000000000025A08306578E9DBDB3CA694FB6DB7579DCFDD3093C096943D6E10B95A2D87AAF2173A02AD98357104C60456A9D08839B
E0048000132f918236c099002786e2669e140d80568b774e
*/