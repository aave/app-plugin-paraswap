import "core-js/stable";
import "regenerator-runtime/runtime";
import Eth from "@ledgerhq/hw-app-eth";
import { byContractAddress } from "@ledgerhq/hw-app-eth/erc20";
import Zemu from "@zondax/zemu";
import { TransportStatusError } from "@ledgerhq/errors";

const sim_options = {
  model: "nanos",
  logging: true,
  start_delay: 2000,
  X11: true,
  custom: '',
};
const Resolve = require("path").resolve;
const APP_PATH = Resolve("elfs/ethereum.elf");

const PARASWAP_LIB = { Paraswap: Resolve("elfs/paraswap.elf") };

test("Test SimpleSwap", async () => {
  jest.setTimeout(100000);
  const sim = new Zemu(APP_PATH, PARASWAP_LIB);
  try {
    await sim.start(sim_options);

    let transport = await sim.getTransport();
    const eth = new Eth(transport);

    // Original TX: https://etherscan.io/tx/0x30f033eae4ef9f426b934b7b494de6ca839cd45f6fc3390690ff894fa6519ec4
    // Send ALCX 0.795106864969129095
    // Receive USDC 1212.688661 (user got 1523.52118)
    // Max Fees: 0.011521299
    await expect(
      eth.signTransaction(
        "44'/60'/0'/0/0",
        "f901ad8202ce850c570bd20083035127941bd435f3c054b6e901b7b108a0ab7617c808677b80b901440863b7ac000000000000000000000000c0aee478e3658e2610c5f7a4a2e1777ce9e4f2ace18a34eb0e04b04f7a0ac29a6e80748dca96319b42c54d679cb821dca90c63030000000000000000000000000000000000000000000000000b08c97b24f59c87000000000000000000000000000000000000000000000000000000004848291500000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000dbdb4d16eda451d0503b854cf79d55697f90c8df000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4826a0649856a7c253e327433f667c4816f3eb616f57c74bd95fe2f7c70b5b51d4e1e1a023227729bf28bfaa85706e738447f3c953ea6f07a6869f616d0a898ff4ca99db"
      )
    ).resolves.toEqual({
      r: "e8c2b5b956b34386e68c5cc5bfc76aac158706430fcf1c71c9f6eb7d9dd690c8",
      s: "064005410a778b047fdd4afcb1e712217c297e5b0a2190f88b9e56ac745fae69",
      v: "26",
    });
  } finally {
    await sim.close();
  }
});

// Works
/*
e00a00006804414c4358dbdb4d16eda451d0503b854cf79d55697f90c8df00000012000000013045022100a5d1e3341d8ccb42b957aa7008b69ab8377768e0178286cbd1706e493910499602207d27eb9c0619ed68078a8d6dd145c48e010356c075b03d2a57b51f1a7f16dca0
e00a0000680455534443a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000006000000013045022100b2e358726e4e6a6752cf344017c0e9d45b9a904120758d45f61b2804f9ad5299022015161ef28d8c4481bd9432c13562def9cce688bcfec896ef244c9a213f106cdd
e0120000680850617261737761701bd435f3c054b6e901b7b108a0ab7617c808677b0863b7ac3045022100f6e1a922c745e244fa3ed9a865491672808ef93f492ee0410861d748c5de201f0220160d6522499f3a84fa3e744b3b81e49e129e997b28495e58671a1169b16fa777
E004000096058000002C8000003C800000000000000000000000F901AD8202CE850C570BD20083035127941BD435F3C054B6E901B7B108A0AB7617C808677B80B901440863B7AC000000000000000000000000C0AEE478E3658E2610C5F7A4A2E1777CE9E4F2ACE18A34EB0E04B04F7A0AC29A6E80748DCA96319B42C54D679CB821DCA90C63030000000000000000000000000000000000000000
E004800096000000000b08c97b24f59c87000000000000000000000000000000000000000000000000000000004848291500000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000300000000000000000000
E0048000960000dbdb4d16eda451d0503b854cf79d55697f90c8df000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4826a0649856a7c253e327433f667c4816f3eb616f57c74bd95fe2f7c70b5b51d4e1e1a023227729bf28bfaa85706e738447f3c953ea6f07a6869f616d0a898ff4
E004800003ca99db
*/